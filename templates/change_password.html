<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cambiar contraseña</title>
  <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
  <style>
    body{font-family:Arial, sans-serif;background:#f4f4f9;display:flex;align-items:center;justify-content:center;min-height:100vh;margin:0;padding:10px}
    .card{background:#fff;max-width:420px;width:100%;padding:20px;border-radius:8px;box-shadow:0 4px 8px rgba(0,0,0,.1)}
    h1{margin:0 0 10px 0;text-align:center;color:#333;font-size:1.4rem}
    .subtitle{margin:0 0 16px 0;text-align:center;color:#555;font-size:0.95rem}

    /* Flash messages (mismo esquema que index.html) */
    .message{ text-align:center; margin:12px 0; padding:10px 12px; border-radius:6px; border:1px solid transparent; display:block; }
    .message.success{ background:#d4edda; color:#155724; border-color:#c3e6cb; }
    .message.error  { background:#f8d7da; color:#721c24; border-color:#f5c6cb; }
    .message.confirm{ background:#fff3cd; color:#856404; border-color:#ffeeba; }

    label{display:block;margin:10px 0 6px 0;color:#333}
    .field{position:relative}
    input[type="password"], input[type="text"]{
      width:100%;box-sizing:border-box;padding:10px 38px 10px 10px;border:1px solid #ddd;border-radius:6px;font-size:15px
    }
    .toggle{
      position:absolute;right:8px;top:50%;transform:translateY(-50%);
      background:none;border:none;cursor:pointer;font-size:12px;color:#007bff;padding:2px 6px;border-radius:4px
    }
    .toggle:hover{ color:#0056b3; }
    .help{font-size:12px;color:#666;margin-top:4px}

    .actions{display:flex;gap:10px;margin-top:16px}
    .btn{flex:1;padding:10px;border:none;border-radius:6px;cursor:pointer;font-size:15px}
    .btn.primary{background:#007bff;color:#fff}
    .btn.primary:hover{background:#0056b3}
    .btn.secondary{background:#e9ecef;color:#333}
    .btn.secondary:hover{background:#dde2e6}

    /* Error de validación cliente */
    #clientError{display:none}
  </style>
</head>
<body>
  <div class="card">
    <h1>Cambiar contraseña</h1>
    <p class="subtitle">Usuario: <strong>{{ session.get('user') }}</strong></p>

    {% with messages = get_flashed_messages(with_categories=True) %}
      {% if messages %}
        <div id="flash-messages">
          {% for category, msg in messages %}
            <div class="message {{ category }}">{{ msg|safe }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}
    <div id="clientError" class="message error"></div>

    <form id="changeForm" method="POST" action="{{ url_for('change_password') }}" novalidate>
      <label for="current_password">Contraseña actual</label>
      <div class="field">
        <input type="password" id="current_password" name="current_password" required autocomplete="current-password" placeholder="••••••••">
        <button class="toggle" type="button" data-target="current_password">ver</button>
      </div>

      <label for="new_password">Nueva contraseña</label>
      <div class="field">
        <input type="password" id="new_password" name="new_password" required minlength="8" autocomplete="new-password" placeholder="Mín. 8 caracteres">
        <button class="toggle" type="button" data-target="new_password">ver</button>
      </div>
      <div class="help">Usa al menos 8 caracteres. Recomendado: mayúsculas, minúsculas, números y símbolos.</div>

      <label for="confirm_password">Confirmar nueva contraseña</label>
      <div class="field">
        <input type="password" id="confirm_password" name="confirm_password" required autocomplete="new-password" placeholder="Repite la nueva contraseña">
        <button class="toggle" type="button" data-target="confirm_password">ver</button>
      </div>

      <div class="actions">
        <a class="btn secondary" href="{{ url_for('index') }}">Cancelar</a>
        <button type="submit" class="btn primary">Guardar</button>
      </div>
    </form>
  </div>

  <script>
    // Mostrar/ocultar contraseñas
    document.querySelectorAll('.toggle').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.getAttribute('data-target');
        const input = document.getElementById(id);
        if (!input) return;
        const isPwd = input.type === 'password';
        input.type = isPwd ? 'text' : 'password';
        btn.textContent = isPwd ? 'ocultar' : 'ver';
      });
    });

    // Validación mínima en cliente
    const form = document.getElementById('changeForm');
    const clientError = document.getElementById('clientError');
    form.addEventListener('submit', (e) => {
      clientError.style.display = 'none';
      clientError.textContent = '';

      const cur = document.getElementById('current_password').value;
      const npw = document.getElementById('new_password').value;
      const cfm = document.getElementById('confirm_password').value;

      if (npw.length < 8) {
        e.preventDefault();
        clientError.textContent = 'La nueva contraseña debe tener al menos 8 caracteres.';
        clientError.style.display = 'block';
        return;
      }
      if (npw !== cfm) {
        e.preventDefault();
        clientError.textContent = 'La confirmación no coincide con la nueva contraseña.';
        clientError.style.display = 'block';
        return;
      }
      if (cur && npw && cur === npw) {
        e.preventDefault();
        clientError.textContent = 'La nueva contraseña no puede ser igual a la actual.';
        clientError.style.display = 'block';
        return;
      }
    });
  </script>
</body>
</html>
